<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Estrai annunci (copia/incolla → CSV)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#f5f6f8;color:#111}
    .wrap{max-width:900px;margin:0 auto;padding:18px 14px 60px}
    .card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
    textarea{width:100%;min-height:240px;padding:12px;border:1px solid #ddd;border-radius:12px;font-size:14px;line-height:1.35}
    button{padding:12px 14px;border-radius:12px;border:1px solid #ddd;background:#fff;cursor:pointer;font-weight:700}
    button.primary{background:#111;color:#fff;border-color:#111}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .muted{color:#666;font-size:13px;margin-top:10px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid #eee;padding:10px;text-align:left;font-size:13px;vertical-align:top}
    th{font-size:12px;color:#666}
    .pill{display:inline-block;border:1px solid #eee;border-radius:999px;padding:2px 8px;font-size:12px;color:#666}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2 style="margin:0">Estrai annunci (manuale-assistito)</h2>
      <div class="muted">
        Apri una pagina “contenitore” (Idealista/Immobiliare ecc.), seleziona e copia il testo della lista annunci,
        incollalo qui e premi “Estrai”. Poi scarica il CSV.
      </div>

      <div style="margin-top:12px">
        <textarea id="input" placeholder="Incolla qui il testo copiato dalla lista annunci..."></textarea>
      </div>

      <div class="row">
        <button class="primary" id="btnExtract">Estrai</button>
        <button id="btnCSV">Scarica CSV</button>
        <button id="btnClear">Pulisci</button>
        <span class="pill" id="count">0 righe</span>
      </div>

      <div id="status" class="muted"></div>

      <table id="tbl" style="display:none">
        <thead>
          <tr>
            <th>#</th>
            <th>Tipologia</th>
            <th>Indirizzo/Zona</th>
            <th>Prezzo</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

<script>
  let rows = [];

  function normalize(s){
    return (s || "")
      .replace(/\u00A0/g, " ")
      .replace(/[ \t]+/g, " ")
      .trim();
  }

  function extractPrice(line){
    // Es: "€ 165.000" / "165.000 €" / "€165.000"
    const m = line.match(/€\s*\d[\d\.\s]*|\d[\d\.\s]*\s*€/);
    return m ? normalize(m[0]).replace(/\s+/g," ") : "";
  }

  function guessType(line){
    // tipologie comuni
    const types = ["Appartamento","Attico","Mansarda","Villa","Casa indipendente","Casa","Rustico","Bilocale","Trilocale","Quadrilocale","Loft","Monolocale","Terratetto","Porzione","Ufficio","Negozio"];
    for (const t of types) {
      if (line.toLowerCase().includes(t.toLowerCase())) return t;
    }
    return "";
  }

  function guessAddress(line){
    // prova: prende tutto prima del prezzo, se presente
    const price = extractPrice(line);
    let s = line;
    if (price) s = line.replace(price, "");
    s = normalize(s);

    // se contiene "via", "viale", "piazza", "corso", "largo", ecc. tendiamo a tenerla
    const tokens = ["via","viale","piazza","corso","largo","vicolo","strada","lungo","piazzale"];
    const low = s.toLowerCase();
    const hasStreet = tokens.some(t => low.includes(t+" "));
    if (hasStreet) return s;

    // altrimenti restituiamo comunque una zona breve
    return s;
  }

  function splitIntoCandidateLines(text){
    // Spezza per newline, ma anche “compatta” righe vuote
    const lines = text.split(/\r?\n/).map(normalize).filter(Boolean);
    return lines;
  }

  function extractRows(text){
    // Heuristica semplice:
    // prende righe che contengono un prezzo in €
    // e usa quella riga come “record”
    const lines = splitIntoCandidateLines(text);
    const out = [];
    for (const ln of lines) {
      const price = extractPrice(ln);
      if (!price) continue;

      const type = guessType(ln);
      const addr = guessAddress(ln);

      out.push({
        type: type || "Immobile",
        address: addr,
        price
      });
    }
    return out;
  }

  function render(){
    const countEl = document.getElementById("count");
    const tbody = document.getElementById("tbody");
    const tbl = document.getElementById("tbl");
    const status = document.getElementById("status");

    countEl.textContent = `${rows.length} righe`;
    tbody.innerHTML = "";

    if (!rows.length) {
      tbl.style.display = "none";
      status.textContent = "Nessun annuncio estratto. Prova a copiare una porzione che includa i prezzi (con €).";
      return;
    }

    tbl.style.display = "";
    status.textContent = "Estratto! Controlla velocemente e poi scarica il CSV.";

    rows.forEach((r, i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${escapeHtml(r.type)}</td>
        <td>${escapeHtml(r.address)}</td>
        <td>${escapeHtml(r.price)}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function toCSV(rows){
    const header = ["Tipologia","Indirizzo/Zona","Prezzo"];
    const lines = [header.join(",")];
    for (const r of rows) {
      const vals = [r.type, r.address, r.price].map(v => `"${String(v||"").replaceAll('"','""')}"`);
      lines.push(vals.join(","));
    }
    return lines.join("\n");
  }

  document.getElementById("btnExtract").addEventListener("click", () => {
    const text = document.getElementById("input").value;
    rows = extractRows(text);
    render();
  });

  document.getElementById("btnCSV").addEventListener("click", () => {
    if (!rows.length) return;
    const csv = toCSV(rows);
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "annunci.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  document.getElementById("btnClear").addEventListener("click", () => {
    document.getElementById("input").value = "";
    rows = [];
    render();
  });

  render();
</script>
</body>
</html>
