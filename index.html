<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ricerca annunci per via + citt√† (gratis)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    #panel{
      position: fixed; top:12px; left:12px; right:12px; z-index:1000;
      background: rgba(255,255,255,.96); border:1px solid #eee; border-radius:14px;
      padding:10px; display:grid; gap:8px;
    }
    .row{ display:flex; gap:8px; flex-wrap:wrap; }
    input{ flex:1; padding:10px 12px; border:1px solid #ddd; border-radius:12px; }
    button{ padding:10px 12px; border:1px solid #ddd; background:#fff; border-radius:12px; cursor:pointer; }
    button.primary{ background:#111; color:#fff; border-color:#111; }
    #status{ font-size:13px; color:#666; }
    #links{ display:grid; gap:8px; max-height:42vh; overflow:auto; }
    .portal{
      border:1px solid #eee; border-radius:12px; padding:10px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .portal small{ color:#666; font-size:12px; }
    .portal a{ font-weight:700; }
    #map{ height:100%; width:100%; }
  </style>
</head>

<body>
  <div id="panel">
    <div class="row">
      <button id="geo">üìç Vicino a me</button>
      <button id="clear">Pulisci</button>
    </div>

    <div class="row">
      <input id="address" placeholder="Scrivi VIA + CITT√Ä (es: Via Roma Milano)" />
      <button class="primary" id="build">Cerca sui portali</button>
    </div>

    <div id="status">Inserisci una via e una citt√†, oppure premi ‚ÄúVicino a me‚Äù.</div>
    <div id="links"></div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const statusEl = document.getElementById("status");
    const linksEl = document.getElementById("links");
    const addressEl = document.getElementById("address");

    // Portali: qui puoi aggiungere/togliere domini
    const PORTALS = [
      { name: "Immobiliare.it", domain: "immobiliare.it" },
      { name: "Idealista", domain: "idealista.it" },
      { name: "Casa.it", domain: "casa.it" },
      { name: "Wikicasa", domain: "wikicasa.it" },
      { name: "Subito", domain: "subito.it" }
    ];

    // Mappa gratis
    const map = L.map("map").setView([41.9028, 12.4964], 12); // fallback Roma
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "¬© OpenStreetMap"
    }).addTo(map);

    let marker;

    function setStatus(msg){ statusEl.textContent = msg; }

    function setMarker(lat, lng, text){
      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map).bindPopup(text).openPopup();
      map.setView([lat, lng], 14);
    }

    // Geocoding gratis via Nominatim
    async function geocode(query){
      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(query)}`;
      const r = await fetch(url);
      const d = await r.json();
      if (!d.length) return null;
      return { lat: +d[0].lat, lng: +d[0].lon, label: d[0].display_name };
    }

    // Reverse geocoding gratis (lat/lng -> indirizzo)
    async function reverseGeocode(lat, lng){
      const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;
      const r = await fetch(url);
      const d = await r.json();
      return d?.display_name || "";
    }

    // ‚úÖ Pulizia: NO civico, NO CAP ‚Äî teniamo VIA + CITT√Ä
    function cleanLocation(text){
      if (!text) return "";

      let s = text;

      // togli CAP (5 cifre)
      s = s.replace(/\b\d{5}\b/g, "");

      // togli numeri civici tipo 12, 12A
      s = s.replace(/\b\d+[A-Za-z]?\b/g, "");

      // pulizia spazi e virgole
      s = s.replace(/\s+/g, " ").replace(/\s*,\s*/g, ",").trim();

      // teniamo solo le prime 2 parti: VIA + CITT√Ä
      const parts = s.split(",").map(p => p.trim()).filter(Boolean);
      return parts.slice(0, 2).join(" ");
    }

    // Query Google: incrocio indirizzo + citt√†, con quote sulla via
    function buildQueryFromClean(cleanText){
      // se cleanText = "Via Roma Milano"
      // vogliamo:  "Via Roma" Milano
      const bits = cleanText.split(" ").filter(Boolean);
      if (bits.length < 2) return cleanText;

      // mettiamo tra virgolette i primi 2-4 token come "via nome"
      const street = bits.slice(0, Math.min(4, bits.length - 1)).join(" ");
      const city = bits.slice(Math.min(4, bits.length - 1)).join(" ");

      // Se city resta vuota, ritorna solo street
      if (!city) return `"${street}"`;

      return `"${street}" ${city}`;
    }

    function googleAllSitesLink(query){
      const u = new URL("https://www.google.com/search");
      u.searchParams.set("q", query);
      return u.toString();
    }

    function googleSiteLink(domain, query){
      const u = new URL("https://www.google.com/search");
      u.searchParams.set("q", `site:${domain} ${query}`);
      return u.toString();
    }

    function renderLinks(query){
      linksEl.innerHTML = "";

      // (Opzionale ma utile) Google senza filtro: massima copertura
      const all = document.createElement("div");
      all.className = "portal";
      all.innerHTML = `
        <div>
          <strong>Google (tutti i siti)</strong><br>
          <small>ricerca generale</small>
        </div>
        <a href="${googleAllSitesLink(query)}" target="_blank" rel="noopener">Apri</a>
      `;
      linksEl.appendChild(all);

      // Portali con site:
      PORTALS.forEach(p => {
        const div = document.createElement("div");
        div.className = "portal";
        div.innerHTML = `
          <div>
            <strong>${p.name}</strong><br>
            <small>site:${p.domain}</small>
          </div>
          <a href="${googleSiteLink(p.domain, query)}" target="_blank" rel="noopener">Apri</a>
        `;
        linksEl.appendChild(div);
      });
    }

    async function buildSearches(){
      linksEl.innerHTML = "";
      const input = addressEl.value.trim();

      if (!input) { setStatus("Scrivi VIA + CITT√Ä (es: Via Roma Milano)."); return; }

      setStatus("Sto interpretando l'indirizzo‚Ä¶");
      const geo = await geocode(input);

      // Se geocode fallisce, usiamo comunque l‚Äôinput dell‚Äôutente per la query
      let labelToUse = input;

      if (geo) {
        setMarker(geo.lat, geo.lng, geo.label);
        labelToUse = geo.label;
      }

      const clean = cleanLocation(labelToUse);
      const query = buildQueryFromClean(clean);

      renderLinks(query);

      setStatus("Fatto ‚úÖ Ora clicca 'Apri' per vedere TUTTI gli annunci trovati.");
    }

    document.getElementById("build").onclick = buildSearches;

    document.getElementById("geo").onclick = () => {
      setStatus("Geolocalizzazione‚Ä¶");
      if (!navigator.geolocation) { setStatus("Geolocalizzazione non supportata."); return; }

      navigator.geolocation.getCurrentPosition(async p => {
        const lat = p.coords.latitude;
        const lng = p.coords.longitude;
        setMarker(lat, lng, "Sei qui");

        try {
          const label = await reverseGeocode(lat, lng);
          // Riempio il campo (verr√† pulito al click su "Cerca sui portali")
          addressEl.value = label || "";
        } catch {}

        setStatus("Posizione trovata ‚úÖ Premi 'Cerca sui portali'.");
      }, e => setStatus("Errore posizione: " + (e.message || "")),
      { enableHighAccuracy:true, timeout:15000, maximumAge:0 });
    };

    document.getElementById("clear").onclick = () => {
      addressEl.value = "";
      linksEl.innerHTML = "";
      setStatus("Pulito. Scrivi VIA + CITT√Ä oppure premi 'Vicino a me'.");
    };

    // Enter per cercare
    addressEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") buildSearches();
    });
  </script>
</body>
</html>
