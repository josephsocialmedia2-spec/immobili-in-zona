<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Immobili in zona (gratis)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    #top {
      position: fixed; left: 12px; right: 12px; top: 12px; z-index: 999;
      background: rgba(255,255,255,.95); border:1px solid #eee; border-radius: 14px;
      padding: 10px; display: grid; gap: 8px;
    }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    input { flex:1; padding:10px 12px; border:1px solid #ddd; border-radius: 12px; }
    button { padding:10px 12px; border:1px solid #ddd; background:#fff; border-radius: 12px; cursor:pointer; }
    button.primary { background:#111; color:#fff; border-color:#111; }
    #status { color:#666; font-size:13px; }
    #links { display:grid; gap:8px; max-height: 34vh; overflow:auto; padding-top: 6px; }
    .portal {
      border:1px solid #eee; border-radius: 12px; padding:10px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .portal strong { font-size:14px; }
    .portal a { font-weight:700; }
    .tag { font-size: 12px; color:#666; }
    #map { height:100%; width:100%; }
  </style>
</head>
<body>
  <div id="top">
    <div class="row">
      <input id="strategy" placeholder="Keyword strategy (es: 'in vendita trilocale')" />
      <button id="btnGeo">üìç Vicino a me</button>
    </div>
    <div class="row">
      <input id="address" placeholder="Inserisci citt√†/indirizzo (es: Milano, Via Torino 10)" />
      <button class="primary" id="btnBuild">Crea ricerche</button>
    </div>
    <div id="status">Pronto.</div>
    <div id="links"></div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const statusEl = document.getElementById("status");
    const linksEl = document.getElementById("links");
    const strategyEl = document.getElementById("strategy");
    const addressEl  = document.getElementById("address");

    // Portali (gratis): aggiungi/togli domini qui
    const PORTALS = [
      { name: "Immobiliare.it", domain: "immobiliare.it" },
      { name: "Idealista",      domain: "idealista.it" },
      { name: "Casa.it",        domain: "casa.it" },
      { name: "Wikicasa",       domain: "wikicasa.it" },
      { name: "Subito (immobili)", domain: "subito.it" }
    ];

    // Mappa gratis (OpenStreetMap)
    const map = L.map("map").setView([41.9028, 12.4964], 12); // fallback Roma
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    let marker = null;

    function setStatus(msg){ statusEl.textContent = msg; }
    function setPoint(lat, lng, label){
      map.setView([lat, lng], 14);
      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map).bindPopup(label || "Punto").openPopup();
    }

    async function geocodeNominatim(query){
      // Geocoding gratis via Nominatim (OSM)
      const url = new URL("https://nominatim.openstreetmap.org/search");
      url.searchParams.set("q", query);
      url.searchParams.set("format", "json");
      url.searchParams.set("limit", "1");

      const res = await fetch(url.toString(), { headers: { "Accept": "application/json" } });
      if (!res.ok) throw new Error("Geocoding non disponibile");
      const data = await res.json();
      if (!data.length) return null;

      return { lat: Number(data[0].lat), lng: Number(data[0].lon), label: data[0].display_name };
    }

    function googleUrlFor(domain, query){
      // Cerca su Google limitando a un portale: site:dominio + query
      const q = `site:${domain} ${query}`.trim();
      const u = new URL("https://www.google.com/search");
      u.searchParams.set("q", q);
      return u.toString();
    }

    function buildQuery(strategy, addressText){
      // La tua ‚Äúkey strategy‚Äù + citt√†/indirizzo
      return [strategy, addressText].map(s => (s || "").trim()).filter(Boolean).join(" ");
    }

    function renderLinks(query){
      linksEl.innerHTML = "";
      for (const p of PORTALS) {
        const link = googleUrlFor(p.domain, query);
        const div = document.createElement("div");
        div.className = "portal";
        div.innerHTML = `
          <div>
            <strong>${p.name}</strong>
            <div class="tag">site:${p.domain}</div>
          </div>
          <a href="${link}" target="_blank" rel="noopener">Apri</a>
        `;
        linksEl.appendChild(div);
      }
    }

    async function buildSearches(){
      linksEl.innerHTML = "";
      const strategy = strategyEl.value.trim();
      const addressText = addressEl.value.trim();

      if (!strategy) { setStatus("Scrivi la keyword strategy (es: 'in vendita bilocale')."); return; }
      if (!addressText) { setStatus("Scrivi una citt√†/indirizzo (oppure usa 'Vicino a me')."); return; }

      setStatus("Sto trovando l'indirizzo sulla mappa‚Ä¶");
      const geo = await geocodeNominatim(addressText);
      if (!geo) { setStatus("Indirizzo non trovato. Prova con: Citt√† + Via + numero."); return; }

      setPoint(geo.lat, geo.lng, geo.label);

      const query = buildQuery(strategy, geo.label);
      renderLinks(query);
      setStatus("Fatto ‚úÖ Ho creato i link di ricerca per i portali.");
    }

    function geoLocate(){
      setStatus("Sto geolocalizzando‚Ä¶");
      if (!navigator.geolocation) { setStatus("Geolocalizzazione non supportata."); return; }

      navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        setPoint(lat, lng, "Sei qui");

        // Provo a ottenere un indirizzo testuale (reverse) gratis
        try {
          const url = new URL("https://nominatim.openstreetmap.org/reverse");
          url.searchParams.set("format", "json");
          url.searchParams.set("lat", lat);
          url.searchParams.set("lon", lng);

          const res = await fetch(url.toString(), { headers: { "Accept": "application/json" } });
          const data = await res.json();
          const label = data?.display_name || "";
          if (label) addressEl.value = label;
        } catch {}

        setStatus("Posizione rilevata ‚úÖ Ora premi 'Crea ricerche'.");
      }, (err) => {
        setStatus("Errore posizione: " + err.message);
      }, { enableHighAccuracy:true, timeout:15000, maximumAge:0 });
    }

    document.getElementById("btnGeo").addEventListener("click", geoLocate);
    document.getElementById("btnBuild").addEventListener("click", buildSearches);
    addressEl.addEventListener("keydown", (e) => { if (e.key === "Enter") buildSearches(); });
  </script>
</body>
</html>
