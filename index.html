    <!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ricerca immobili (gratis)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    #panel{
      position: fixed; top:12px; left:12px; right:12px; z-index:1000;
      background: rgba(255,255,255,.96); border:1px solid #eee; border-radius:14px;
      padding:10px; display:grid; gap:8px;
    }
    .row{ display:flex; gap:8px; flex-wrap:wrap; }
    input{ flex:1; padding:10px 12px; border:1px solid #ddd; border-radius:12px; }
    button{ padding:10px 12px; border:1px solid #ddd; background:#fff; border-radius:12px; cursor:pointer; }
    button.primary{ background:#111; color:#fff; border-color:#111; }
    #status{ font-size:13px; color:#666; }
    #links{ display:grid; gap:8px; max-height:40vh; overflow:auto; }
    .portal{
      border:1px solid #eee; border-radius:12px; padding:10px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .portal small{ color:#666; font-size:12px; }
    .portal a{ font-weight:700; }
    #map{ height:100%; width:100%; }
  </style>
</head>

<body>
  <div id="panel">
    <div class="row">
      <input id="strategy" placeholder="Keyword (es: in vendita trilocale)" />
      <button id="geo">üìç Vicino a me</button>
    </div>

    <div class="row">
      <input id="address" placeholder="Citt√† o indirizzo (senza civico va benissimo)" />
      <button class="primary" id="build">Crea ricerche</button>
    </div>

    <div id="status">Pronto.</div>
    <div id="links"></div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const statusEl = document.getElementById("status");
    const linksEl = document.getElementById("links");
    const strategyEl = document.getElementById("strategy");
    const addressEl = document.getElementById("address");

    // Portali: link = "Apri Google con site:dominio"
    const PORTALS = [
      { name: "Immobiliare.it", domain: "immobiliare.it" },
      { name: "Idealista", domain: "idealista.it" },
      { name: "Casa.it", domain: "casa.it" },
      { name: "Wikicasa", domain: "wikicasa.it" },
      { name: "Subito", domain: "subito.it" }
    ];

    // Mappa gratis
    const map = L.map("map").setView([41.9028, 12.4964], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "¬© OpenStreetMap"
    }).addTo(map);

    let marker;

    function setStatus(msg){ statusEl.textContent = msg; }

    function setMarker(lat, lng, text){
      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map).bindPopup(text).openPopup();
      map.setView([lat, lng], 14);
    }

    async function geocode(query){
      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(query)}`;
      const r = await fetch(url);
      const d = await r.json();
      if (!d.length) return null;
      return { lat: +d[0].lat, lng: +d[0].lon, label: d[0].display_name };
    }

    async function reverseGeocode(lat, lng){
      const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;
      const r = await fetch(url);
      const d = await r.json();
      return d?.display_name || "";
    }

    // ‚úÖ Pulizia: NO civico, NO CAP ‚Äî prendiamo via + citt√†
    function cleanLocation(text){
      if (!text) return "";

      let s = text;

      // via Roma 12 -> via Roma
      s = s.replace(/\b\d+[A-Za-z]?\b/g, "");

      // rimuovi CAP 5 cifre
      s = s.replace(/\b\d{5}\b/g, "");

      // pulizia spazi e virgole
      s = s.replace(/\s+/g, " ").replace(/\s*,\s*/g, ",").trim();

      // prendi solo le prime 2 parti (via + citt√†)
      const parts = s.split(",").map(p => p.trim()).filter(Boolean);
      return parts.slice(0, 2).join(" ");
    }

    function googleAllSitesLink(query){
      const u = new URL("https://www.google.com/search");
      u.searchParams.set("q", query);
      return u.toString();
    }

    function googleSiteLink(domain, query){
      const u = new URL("https://www.google.com/search");
      u.searchParams.set("q", `site:${domain} ${query}`);
      return u.toString();
    }

    function renderLinks(finalQuery){
      linksEl.innerHTML = "";

      // üî• Link "TUTTI i siti" (massimo numero risultati)
      const all = document.createElement("div");
      all.className = "portal";
      all.innerHTML = `
        <div>
          <strong>Google (tutti i siti)</strong><br>
          <small>nessun filtro site:</small>
        </div>
        <a href="${googleAllSitesLink(finalQuery)}" target="_blank" rel="noopener">Apri</a>
      `;
      linksEl.appendChild(all);

      // Portali
      PORTALS.forEach(p => {
        const div = document.createElement("div");
        div.className = "portal";
        div.innerHTML = `
          <div>
            <strong>${p.name}</strong><br>
            <small>site:${p.domain}</small>
          </div>
          <a href="${googleSiteLink(p.domain, finalQuery)}" target="_blank" rel="noopener">Apri</a>
        `;
        linksEl.appendChild(div);
      });
    }

    async function buildSearches(){
      const strategy = strategyEl.value.trim();
      const address = addressEl.value.trim();

      if (!strategy) { setStatus("Scrivi la keyword (es: in vendita bilocale)."); return; }
      if (!address) { setStatus("Scrivi citt√†/indirizzo (senza civico va benissimo)."); return; }

      setStatus("Sto cercando l'indirizzo‚Ä¶");
      const geo = await geocode(address);
      if (!geo) { setStatus("Indirizzo non trovato. Prova con 'Via + Citt√†'."); return; }

      setMarker(geo.lat, geo.lng, geo.label);

      const cleanAddress = cleanLocation(geo.label);
      const finalQuery = `${strategy} ${cleanAddress}`.trim();

      // ‚úÖ NON cataloghiamo nulla: solo link che aprono TUTTI i risultati
      renderLinks(finalQuery);

      setStatus("Fatto ‚úÖ Ora clicca 'Apri' per vedere TUTTI gli immobili trovati.");
    }

    document.getElementById("build").onclick = buildSearches;

    document.getElementById("geo").onclick = () => {
      setStatus("Geolocalizzazione‚Ä¶");
      if (!navigator.geolocation) { setStatus("Geolocalizzazione non supportata."); return; }

      navigator.geolocation.getCurrentPosition(async p => {
        const lat = p.coords.latitude;
        const lng = p.coords.longitude;

        setMarker(lat, lng, "Sei qui");

        try {
          const label = await reverseGeocode(lat, lng);
          addressEl.value = label || "";
        } catch {}

        setStatus("Posizione trovata ‚úÖ Premi 'Crea ricerche'.");
      }, e => setStatus("Errore posizione: " + (e.message || "")),
      { enableHighAccuracy:true, timeout:15000, maximumAge:0 });
    };
  </script>
</body>
</html>
